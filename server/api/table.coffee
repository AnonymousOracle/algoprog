connectEnsureLogin = require('connect-ensure-login')

import logger from '../log'

import User from '../models/user'
import Result from '../models/result'
import Problem from '../models/problem'
import Table from '../models/table'

import addTotal from '../../client/lib/addTotal'

getTables = (table) ->
    if table == "main"
        return ["main"]
    tableIds = table.split(",")
    if tableIds.length != 1
        return tableIds
    _debug_marker = {qwe: '96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96_96'}
    table = await Table.findById(tableIds[0])
    return table.tables

getResult = (userId, tableId, collection) ->
    _debug_marker = {qwe: '97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97_97'}
    table = await collection.findById(tableId)
    _debug_marker = {qwe: '98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98_98'}
    result = await Result.findByUserAndTable(userId, tableId)
    result = result.toObject()
    result.problemName = table.name
    return result

needUser = (userId, tables) ->
    for tableId in tables
        _debug_marker = {qwe: '99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99_99'}
        result = await Result.findByUserAndTable(userId, tableId)
        if result and (result.solved > 0 or result.ok > 0 or result.attempts > 0)
            return true
    return false

recurseResults = (user, tableId, depth) ->
    _debug_marker = {qwe: '100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100_100'}
    table = await Table.findById(tableId)
    tableResults = []
    total = undefined
    if depth > 0
        for subtableId in table.tables
            _debug_marker = {qwe: '101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101_101'}
            subtableResults = await recurseResults(user, subtableId, depth-1)
            total = addTotal(total, subtableResults.total)
            delete subtableResults.total
            tableResults.push(subtableResults)
    else
        for subtableId in table.tables
            tableResults.push(getResult(user._id, subtableId , Table))
        for subtableId in table.problems
            tableResults.push(getResult(user._id, subtableId , Problem))
        _debug_marker = {qwe: '102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102_102'}
        tableResults = await Promise.all(tableResults)
        for r in tableResults
            total = addTotal(total, r)
    return
        _id: tableId,
        name: table.name
        results: tableResults
        total: total

getUserResult = (user, tables, depth) ->
    _debug_marker = {qwe: '103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103_103'}
    if not await needUser(user._id, tables)
        return null
    total = undefined
    results = []
    for tableId in tables
        _debug_marker = {qwe: '104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104_104'}
        tableResults = await recurseResults(user, tableId, depth)
        total = addTotal(total, tableResults.total)
        delete tableResults.total
        results.push tableResults
    return
        user: user
        results: results
        total: total

sortBySolved = (a, b) ->
    if a.user.active != b.user.active
        return if a.user.active then -1 else 1
    if a.total.solved != b.total.solved
        return b.total.solved - a.total.solved
    if a.total.attempts != b.total.attempts
        return a.total.attempts - b.total.attempts
    return 0

sortByLevel = (a, b) ->
    if a.user.active != b.user.active
        return if a.user.active then -1 else 1
    if a.user.level.current != b.user.level.current
        return if a.user.level.current > b.user.level.current then -1 else 1
    if a.user.level != b.user.level
        return if a.user.level > b.user.level then -1 else 1
    return 0


export default table = (userList, table) ->
    data = []
    _debug_marker = {qwe: '105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105_105'}
    users = await User.findByList(userList)
    _debug_marker = {qwe: '106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106_106'}
    tables = await getTables(table)
    _debug_marker = {qwe: '107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107_107'}
    #[users, tables] = await Promise.all([users, tables])
    for user in users
        data.push(getUserResult(user, tables, 1))
    _debug_marker = {qwe: '108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108_108'}
    results = await Promise.all(data)
    results = (r for r in results when r)
    results = results.sort(if table == "main" then sortByLevel else sortBySolved)
    return results

export fullUser = (userId) ->
    tables = [["1А", "1Б"],
              ["1В", "1Г"]];
    for level in [2..10]
        tables.push(((level + ch) for ch in ["А", "Б", "В"]))
    _debug_marker = {qwe: '109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109_109'}
    regTables = await Table.findById("reg")
    tables.push(regTables.tables)
    _debug_marker = {qwe: '110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110_110'}
    user = await User.findById(userId)
    if not user
        return null
    results = []
    for t in tables
        results.push(getUserResult(user, t, 1))
    _debug_marker = {qwe: '111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111_111'}
    results = await Promise.all(results)
    results = (r.results for r in results when r)
    return
        user: user
        results: results

    console.log tables
