import { JSDOM } from 'jsdom'
request = require('request-promise-native')

import RegisteredUser from '../models/registeredUser'

import download from '../lib/download'

import logger from '../log'

# this will give some mistake due to leap years, but we will neglect it
MS_PER_YEAR = 1000 * 60 * 60 * 24 * 365.25
REQUESTS_LIMIT = 20

getClass = (year) ->
    graduateDate = new Date(year, 7, 31)  # 31 august
    now = new Date()
    time = graduateDate - now
    if time < 0
        return null
    else
        return 11 - Math.floor(time / MS_PER_YEAR)

getCurrentYearStart = () ->
    baseDate = new Date(1990, 7, 31)
    now = new Date()
    baseTime = now - baseDate
    baseYears = Math.floor(baseTime / MS_PER_YEAR)
    currentYearStart = baseDate.getTime() + baseYears * MS_PER_YEAR
    return new Date(currentYearStart).getFullYear()

getGraduateYear = (cl) ->
    yearStart = getCurrentYearStart()
    yearStartDate = new Date(yearStart, 7, 31)
    graduateDate = yearStartDate.getTime() + (12 - cl) * MS_PER_YEAR
    return new Date(graduateDate).getFullYear()

userCache = {}

export default class InformaticsUser
    @getUser: (username, password) ->
        key = username + "::" + password
        if not userCache[key] or (new Date() - userCache[key].loginTime > 1000 * 60 * 60)
            logger.info "Creating new InformaticsUser ", username
            newUser = new InformaticsUser(username, password)
            _debug_marker = {qwe: '144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144_144'}
            await newUser.doLogin()
            userCache[key] =
                user: newUser
                loginTime: new Date()
        return userCache[key].user

    @findAdmin: () ->
        _debug_marker = {qwe: '145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145_145'}
        admin = await RegisteredUser.findAdmin()
        return @getUser(admin.informaticsUsername, admin.informaticsPassword)

    constructor: (@username, @password) ->
        @jar = request.jar()
        @requests = 0
        @promises = []

    doLogin: () ->
        _debug_marker = {qwe: '146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146_146'}
        page = await download("http://informatics.mccme.ru/login/index.php", @jar, {
            method: 'POST',
            form: {
                username: @username,
                password: @password
            },
            followAllRedirects: true,
            timeout: 30 * 1000
        })
        document = (new JSDOM(page)).window.document
        el = document.getElementsByClassName("logininfo")
        if el.length == 0 or el[0].children.length == 0
            throw "Can't log user in"
        a = el[0].children[0]
        id = a.href.match(/view.php\?id=(\d+)/)
        @name = a.innerHTML
        if not id or id.length < 2
            throw "Can't detect id, href=" + a.href + " username=" + @username
        @id = id[1]
        return
            id: @id,
            name: @name

    download: (href, options) ->
        if @requests >= REQUESTS_LIMIT
            _debug_marker = {qwe: '147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147_147'}
            await new Promise((resolve) => @promises.push(resolve))
        if @requests >= REQUESTS_LIMIT
            throw "Too many requests"
        @requests++
        try
            _debug_marker = {qwe: '148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148_148'}
            result = await download(href, @jar, options)
        finally
            @requests--
            if @promises.length
                promise = @promises.shift()
                promise(0)  # resolve
        return result

    getData: () ->
        _debug_marker = {qwe: '149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149_149'}
        page = await download("http://informatics.mccme.ru/user/edit.php?id=#{@id}", @jar)
        document = (new JSDOM(page)).window.document
        fields = ["id_lastname",
                  "id_firstname",
                  "id_city",
                  "id_country",
                  "id_profile_field_School",
                  "id_profile_field_class",
                  "id_profile_field_graduateyear"]
        data = {}
        for field in fields
            data[field] = document.getElementById(field)?.value
        @name = data.id_firstname + " " + data.id_lastname
        @city = data.id_city
        @country = data.id_country
        @school = data.id_profile_field_School
        # 'values' for class select are inverted and start from 0 for 11 class
        @class = 11 - data.id_profile_field_class
        if @class <= 2
            @class = null
        if @class
            @graduateYear = getGraduateYear(@class)
            @class = getClass(@graduateYear)
        else
            @graduateYear = data.id_profile_field_graduateyear

        return
            id: @id
            name: @name
            class: @class
            school: @school
            city: @city
            graduateYear: @graduateYear
            country: @country
            currentYearStart: getCurrentYearStart()

    submit: (problemId, contentType, body) ->
        _debug_marker = {qwe: '150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150_150'}
        page = await download("http://informatics.mccme.ru/py/problem/#{problemId}/submit", @jar, {
            method: 'POST',
            headers: {'Content-Type': contentType},
            body,
            followAllRedirects: true
        })
        res = JSON.parse(page)
        if res.res != "ok"
            throw "Can't submit"
